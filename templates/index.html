<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking de Depositantes - AsafeBroker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .card-shadow-lg {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .trophy-gold {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #92400e;
    }

    .trophy-silver {
      background: linear-gradient(135deg, #c0c0c0 0%, #e5e7eb 100%);
      color: #374151;
    }

    .trophy-bronze {
      background: linear-gradient(135deg, #cd7f32 0%, #d97706 100%);
      color: #92400e;
    }

    .animate-fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }

    .animate-slide-up {
      animation: slideUp 0.8s ease-out forwards;
    }

    .animate-scale-in {
      animation: scaleIn 0.5s ease-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .loading-shimmer {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .rank-number {
      font-weight: 700;
      font-size: 1.5rem;
      line-height: 1;
    }

    .podium-card {
      transition: all 0.3s ease;
    }

    .podium-card:hover {
      transform: translateY(-4px);
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Dark mode styles */
    html.dark {
      background-color: #0f172a;
      color: #e2e8f0;
    }

    html.dark .gradient-bg {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }

    html.dark .stats-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(51, 65, 85, 0.3);
    }

    html.dark .bg-white { background-color: #1e293b; color: #e2e8f0; }
    html.dark .text-gray-900 { color: #e2e8f0; }
    html.dark .text-gray-700 { color: #cbd5e0; }
    html.dark .text-gray-600 { color: #a0aec0; }
    html.dark .text-gray-500 { color: #718096; }
    html.dark .border-gray-200 { border-color: #4a5568; }
    html.dark .bg-gray-50 { background-color: #2d3748; }
    html.dark .bg-gray-100 { background-color: #4a5568; }
  </style>
</head>

<body class="gradient-bg min-h-screen">
  <!-- Loading Indicator -->
  <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-90 dark:bg-gray-900 dark:bg-opacity-90 flex items-center justify-center z-50">
    <div class="flex flex-col items-center">
      <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-600 dark:text-gray-400 font-medium">Carregando ranking...</p>
    </div>
  </div>

  <div class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header -->
      <div class="text-center mb-12 animate-fade-in">
        <div class="flex items-center justify-between mb-6">
          <a href="/" class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span>Voltar ao Dashboard</span>
          </a>
          
          <button id="themeToggle" class="p-3 rounded-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-300 card-shadow">
            <i data-lucide="sun" class="w-5 h-5 light-icon"></i>
            <i data-lucide="moon" class="w-5 h-5 dark-icon hidden"></i>
          </button>
        </div>
        
        <div class="mb-8">
          <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
            üèÜ Ranking de Depositantes
          </h1>
          <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
            Os maiores investidores da AsafeBroker no per√≠odo selecionado
          </p>
        </div>

        <!-- Period Filter -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 card-shadow max-w-md mx-auto">
          <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Per√≠odo de An√°lise</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data In√≠cio</label>
              <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Fim</label>
              <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
          </div>
          <button id="updateRanking" class="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
            Atualizar Ranking
          </button>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div id="statisticsCards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 animate-slide-up">
        <!-- Cards will be inserted here -->
      </div>

      <!-- Podium Section -->
      <div class="mb-16 animate-scale-in">
        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-12">ü•á P√≥dio dos Campe√µes</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto" id="podiumSection">
          <!-- Podium cards will be inserted here -->
        </div>
      </div>

      <!-- Full Ranking Table -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl card-shadow-lg overflow-hidden animate-fade-in">
        <div class="p-8 border-b border-gray-200 dark:border-gray-700">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
            <i data-lucide="list" class="w-6 h-6 text-blue-600"></i>
            Ranking Completo
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mt-2">Todos os depositantes ordenados por valor total</p>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Posi√ß√£o</th>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Investidor</th>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Pa√≠s</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-gray-100">Total Depositado</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-gray-100">N¬∫ Dep√≥sitos</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-gray-100">M√©dia por Dep√≥sito</th>
              </tr>
            </thead>
            <tbody id="rankingTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
              <!-- Table rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();

      // Theme management
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.classList.add(savedTheme);
      updateThemeIcons();

      function updateThemeIcons() {
        const lightIcon = document.querySelector('.light-icon');
        const darkIcon = document.querySelector('.dark-icon');
        if (document.documentElement.classList.contains('dark')) {
          lightIcon.classList.add('hidden');
          darkIcon.classList.remove('hidden');
        } else {
          lightIcon.classList.remove('hidden');
          darkIcon.classList.add('hidden');
        }
      }

      document.getElementById('themeToggle').addEventListener('click', () => {
        if (document.documentElement.classList.contains('light')) {
          document.documentElement.classList.remove('light');
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        } else {
          document.documentElement.classList.remove('dark');
          document.documentElement.classList.add('light');
          localStorage.setItem('theme', 'light');
        }
        updateThemeIcons();
      });

      // Date initialization
      const today = new Date().toISOString().split('T')[0];
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      document.getElementById('startDate').value = thirtyDaysAgo;
      document.getElementById('endDate').value = today;

      // Data fetching and rendering
      async function fetchRankingData() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.classList.remove('hidden');

        try {
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          
          const response = await fetch(`/ranking-data?startDate=${startDate}&endDate=${endDate}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          renderStatistics(data.statistics);
          renderPodium(data.ranking);
          renderFullRanking(data.ranking);
          
        } catch (error) {
          console.error('Erro ao buscar dados do ranking:', error);
          alert('Erro ao carregar dados do ranking: ' + error.message);
        } finally {
          loadingIndicator.classList.add('hidden');
        }
      }

      function renderStatistics(stats) {
        const container = document.getElementById('statisticsCards');
        container.innerHTML = `
          <div class="stats-card rounded-2xl p-6 text-center">
            <div class="flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-full mx-auto mb-4">
              <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">US$ ${stats.total_deposited.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h3>
            <p class="text-gray-600 dark:text-gray-400">Total Depositado</p>
          </div>
          
          <div class="stats-card rounded-2xl p-6 text-center">
            <div class="flex items-center justify-center w-12 h-12 bg-green-100 dark:bg-green-900 rounded-full mx-auto mb-4">
              <i data-lucide="trending-up" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">${stats.total_deposits.toLocaleString('pt-BR')}</h3>
            <p class="text-gray-600 dark:text-gray-400">Total de Dep√≥sitos</p>
          </div>
          
          <div class="stats-card rounded-2xl p-6 text-center">
            <div class="flex items-center justify-center w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-full mx-auto mb-4">
              <i data-lucide="users" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">${stats.total_users.toLocaleString('pt-BR')}</h3>
            <p class="text-gray-600 dark:text-gray-400">Investidores Ativos</p>
          </div>
        `;
        lucide.createIcons();
      }

      function renderPodium(ranking) {
        const container = document.getElementById('podiumSection');
        
        if (ranking.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500 col-span-2">Nenhum dado encontrado para o per√≠odo selecionado.</p>';
          return;
        }

        const first = ranking[0];
        const second = ranking[1];

        let podiumHTML = '';

        // First Place
        if (first) {
          podiumHTML += `
            <div class="podium-card bg-white dark:bg-gray-800 rounded-3xl p-8 card-shadow-lg relative overflow-hidden">
              <div class="absolute top-0 right-0 w-24 h-24 trophy-gold rounded-full -mr-12 -mt-12 opacity-20"></div>
              <div class="relative z-10">
                <div class="flex items-center justify-between mb-6">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 trophy-gold rounded-full flex items-center justify-center">
                      <span class="rank-number">1</span>
                    </div>
                    <div>
                      <h3 class="text-xl font-bold text-gray-900 dark:text-white">ü•á Primeiro Lugar</h3>
                      <p class="text-gray-600 dark:text-gray-400">Campe√£o dos Investimentos</p>
                    </div>
                  </div>
                  <i data-lucide="crown" class="w-8 h-8 text-yellow-500"></i>
                </div>
                
                <div class="space-y-4">
                  <div>
                    <h4 class="text-2xl font-bold text-gray-900 dark:text-white">${first.name}</h4>
                    <p class="text-gray-600 dark:text-gray-400">${first.email}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">${first.country || 'N/A'}</p>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-center">
                      <p class="text-2xl font-bold text-green-600 dark:text-green-400">US$ ${first.total_amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                      <p class="text-sm text-gray-600 dark:text-gray-400">Total Depositado</p>
                    </div>
                    <div class="text-center">
                      <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${first.deposit_count}</p>
                      <p class="text-sm text-gray-600 dark:text-gray-400">Dep√≥sitos</p>
                    </div>
                  </div>
                  
                  <div class="text-center pt-2">
                    <p class="text-lg font-semibold text-gray-700 dark:text-gray-300">
                      M√©dia: US$ ${(first.total_amount / first.deposit_count).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        // Second Place
        if (second) {
          podiumHTML += `
            <div class="podium-card bg-white dark:bg-gray-800 rounded-3xl p-8 card-shadow-lg relative overflow-hidden">
              <div class="absolute top-0 right-0 w-24 h-24 trophy-silver rounded-full -mr-12 -mt-12 opacity-20"></div>
              <div class="relative z-10">
                <div class="flex items-center justify-between mb-6">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 trophy-silver rounded-full flex items-center justify-center">
                      <span class="rank-number">2</span>
                    </div>
                    <div>
                      <h3 class="text-xl font-bold text-gray-900 dark:text-white">ü•à Segundo Lugar</h3>
                      <p class="text-gray-600 dark:text-gray-400">Vice-Campe√£o</p>
                    </div>
                  </div>
                  <i data-lucide="medal" class="w-8 h-8 text-gray-400"></i>
                </div>
                
                <div class="space-y-4">
                  <div>
                    <h4 class="text-2xl font-bold text-gray-900 dark:text-white">${second.name}</h4>
                    <p class="text-gray-600 dark:text-gray-400">${second.email}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">${second.country || 'N/A'}</p>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-center">
                      <p class="text-2xl font-bold text-green-600 dark:text-green-400">US$ ${second.total_amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                      <p class="text-sm text-gray-600 dark:text-gray-400">Total Depositado</p>
                    </div>
                    <div class="text-center">
                      <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${second.deposit_count}</p>
                      <p class="text-sm text-gray-600 dark:text-gray-400">Dep√≥sitos</p>
                    </div>
                  </div>
                  
                  <div class="text-center pt-2">
                    <p class="text-lg font-semibold text-gray-700 dark:text-gray-300">
                      M√©dia: US$ ${(second.total_amount / second.deposit_count).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        container.innerHTML = podiumHTML;
        lucide.createIcons();
      }

      function renderFullRanking(ranking) {
        const tbody = document.getElementById('rankingTableBody');
        
        if (ranking.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Nenhum dado encontrado para o per√≠odo selecionado.</td></tr>';
          return;
        }

        tbody.innerHTML = ranking.map((user, index) => {
          const position = index + 1;
          let positionDisplay = position.toString();
          let positionClass = 'text-gray-600 dark:text-gray-400';
          
          if (position === 1) {
            positionDisplay = 'ü•á 1¬∫';
            positionClass = 'text-yellow-600 font-bold';
          } else if (position === 2) {
            positionDisplay = 'ü•à 2¬∫';
            positionClass = 'text-gray-500 font-bold';
          } else if (position === 3) {
            positionDisplay = 'ü•â 3¬∫';
            positionClass = 'text-yellow-700 font-bold';
          }

          const average = user.total_amount / user.deposit_count;
          
          return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <td class="px-6 py-4">
                <span class="${positionClass} font-semibold">${positionDisplay}</span>
              </td>
              <td class="px-6 py-4">
                <div>
                  <div class="font-semibold text-gray-900 dark:text-white">${user.name}</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">${user.email}</div>
                </div>
              </td>
              <td class="px-6 py-4 text-gray-600 dark:text-gray-400">
                ${user.country || 'N/A'}
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-bold text-green-600 dark:text-green-400">
                  US$ ${user.total_amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                </span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-semibold text-blue-600 dark:text-blue-400">
                  ${user.deposit_count}
                </span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="text-gray-700 dark:text-gray-300">
                  US$ ${average.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                </span>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Event listeners
      document.getElementById('updateRanking').addEventListener('click', fetchRankingData);

      // Initial load
      fetchRankingData();
    });
  </script>
</body>
</html>
